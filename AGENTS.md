Scope
- Applies to the entire repository and all agents/tools.

Monorepo Policy (Amplify + Flutter)
- Single repo contains both Flutter app and AWS Amplify backend.
- Option B (decided): do NOT commit `lib/amplifyconfiguration.dart`.
- Each developer runs `amplify pull` per environment locally to generate config.

Ownership Boundaries
- Backend (BE)
  - Owns: `amplify/**`, backend-related `docs/**`, release and environment lifecycle.
  - May add/edit GraphQL schema, auth/storage/api resources via Amplify CLI only.
- Frontend (FE)
  - Owns: `lib/**` app code (UI/UX, state, screens, services).
  - Uses the generated `lib/amplifyconfiguration.dart` and `lib/services/amplify_service.dart` for initialization.

Git & Commit Rules
- Commit the `amplify/` directory, except local-only files:
  - Ignore: `amplify/#current-cloud-backend/`, `amplify/.config/local-*`, `amplify/.config/local-env-info.json`.
- Do NOT commit: `lib/amplifyconfiguration.dart` (generated by `amplify pull`).
- Keep backend docs up to date on schema or auth changes.

Branch ↔ Environment Mapping
- `develop` → `dev` Amplify environment (testing)
- `main` → `prod` Amplify environment (production)
- Commands:
  - `amplify env add` (create env)
  - `amplify env checkout dev|prod` (switch)
  - `amplify push` (deploy current env)

Free Tier Guardrails (must-follow)
- Region: `ap-northeast-2` (Seoul) unless strong reason otherwise.
- DynamoDB: On-demand capacity, no provisioned throughput; avoid hot partitions; add GSIs only when needed.
- AppSync: Prefer Cognito auth; avoid long-lived API Keys (disable in prod).
- S3: Single region bucket; avoid public access; enable default encryption; lifecycle rules later if needed.
- CloudWatch Logs: Set retention to 7 days for Lambda/AppSync resolvers.
- Optional services (Pinpoint/OpenSearch/Personalize) are off until approved to control cost.

Standard Backend Workflow
1) One-time setup per machine
   - `npm i -g @aws-amplify/cli`
   - `amplify configure` (create/select AWS profile)
2) Create/Update backend (dev)
   - `amplify init` (env: `dev`)
   - `amplify add auth` (Cognito Hosted UI + Social: Google/OIDC Naver/Kakao)
   - `amplify add api` (AppSync GraphQL + DynamoDB)
   - optional: `amplify add storage` (S3)
   - `amplify push`
3) Add production env
   - `amplify env add` (name: `prod`)
   - `amplify env checkout prod` → `amplify push`
   - switch back with `amplify env checkout dev`
4) Frontend sync per env (Option B)
   - `amplify pull --appId <APP_ID> --envName dev|prod`
   - Generates `lib/amplifyconfiguration.dart` locally (git-ignored).

Mobile Auth Redirects (Hosted UI)
- Deep link scheme: e.g., `yuno://auth` for sign-in, `yuno://signout` for sign-out.
- Android: add intent-filter for scheme/host/path in `AndroidManifest.xml`.
- iOS: add URL Types (CFBundleURLSchemes) in Info.plist.
- Add the same callback/sign-out URLs in Cognito App client config.

Social Identity Providers
- Google (OAuth)
  - Create OAuth client; copy Client ID/Secret into Cognito IdP config.
  - Scopes: `openid profile email`.
- Naver/Kakao (OIDC via Cognito)
  - Register OIDC app; note Issuer/Authorization/Token/UserInfo endpoints.
  - Scopes: `openid profile email` (subject to provider support).
  - Map claims (email, name) in Cognito IdP settings.

Change Management
- If `amplify/` changes in a PR, include a note for FE:
  - “Run: `amplify pull --appId <APP_ID> --envName dev|prod`”.
- Schema changes should use GraphQL directives (`@model`, `@auth`) and follow least-privilege access.
- Avoid manual AWS console edits; prefer Amplify CLI so state remains consistent.

Security Notes
- `lib/amplifyconfiguration.dart` holds endpoints/IDs (not credentials) but remains uncommitted to prevent env drift.
- Never store secrets in the repo. Use Cognito, SSM, or Secrets Manager as appropriate.
- Restrict public access on S3; enable bucket encryption.

Agent/Automation Guidance
- Agents should only modify files under their ownership boundaries above.
- Do not run `amplify` commands automatically without explicit user approval.
- Prefer small, atomic PRs; include checklists from the template.

Onboarding Checklist
- Install: Node.js LTS, Amplify CLI, Flutter SDK.
- AWS account + IAM user with Amplify/IAM/AppSync/DynamoDB/S3 permissions.
- `amplify pull` for the target env; add deep link config in mobile if working on auth.

Troubleshooting Quick Tips
- Auth redirect loop: confirm deep link scheme matches Cognito callback URL.
- API unauthorized: check `@auth` rules and default AppSync auth mode (Cognito).
- Missing configuration: ensure `lib/amplifyconfiguration.dart` exists (pull again).

References
- See `docs/amplify-monorepo-setup.md` for step-by-step setup and troubleshooting.
